<ng-container
    *ngIf="{
        isOpen: (isOpen$ | async) || false,
        context: context$ | async,
        status: status$ | async,
    } as data"
>
    <p-dialog
        [(visible)]="data.isOpen"
        (onHide)="close()"
        [modal]="true"
        [style]="{ width: '60vw', height: 'auto' }"
        styleClass="add-otc-dialog"
        [breakpoints]="{ '720px': '95vw' }"
        [showHeader]="false"
        [draggable]="false"
        [resizable]="false"
        [dismissableMask]="true"
        position="center"
        appendTo="body"
    >
        <div class="modal-inner-container">
            <div class="modal-header">
                <h2>Book OTC</h2>
                <ng-container *ngIf="data.context">
                    <ng-container
                        *ngIf="data.context.isOpen && !data.context.isClosed"
                    >
                        <div class="assignment-status-banner open">
                            <i class="pi pi-exclamation-circle"></i>
                            <span>
                                This tour is available to add bookings
                            </span>
                        </div>
                    </ng-container>
                    <ng-container
                        *ngIf="data.context.isClosed && !data.context.isOpen"
                    >
                        <div class="assignment-status-banner closed">
                            <i class="pi pi-exclamation-triangle"></i>
                            <span>
                                Tour is Closed. Check with tour management for
                                booking availability
                            </span>
                        </div>
                    </ng-container>
                    <ng-container
                        *ngIf="!data.context.isOpen && !data.context.isClosed"
                    >
                        <div class="assignment-status-banner">
                            <i class="pi pi-exclamation-triangle"></i>
                            <span>
                                Check with tour management for booking
                                availability
                            </span>
                        </div>
                    </ng-container>
                </ng-container>
            </div>
            <app-modal-tour-details
                [assignment]="data.context"
                [tourDate]="data.context && data.context.tourDate"
            ></app-modal-tour-details>
            <ng-container
                *ngIf="{
                        agentUsers: agentUsers$ | async,
                        pickupLocations: pickupLocations$ | async,
                        shipsInPort: shipsInPort$ | async,
                    } as formDropdowns"
            >
                <ng-container *ngIf="formDropdowns.agentUsers">
                    <form
                        [formGroup]="addOtcForm"
                        (ngSubmit)="save(data.context)"
                    >
                        <!-- agent -->
                        <div class="field-row-container">
                            <div class="field-container">
                                <label htmlFor="agent">Agent</label>
                                <p-dropdown
                                    [options]="
                                        formDropdowns.agentUsers.length > 0
                                            ? formDropdowns.agentUsers
                                            : []
                                    "
                                    placeholder="Select Agent"
                                    formControlName="agent"
                                    [autoDisplayFirst]="false"
                                    [showClear]="true"
                                    appendTo="body"
                                >
                                    <ng-template
                                        pTemplate="item"
                                        let-agentOption
                                    >
                                        <span>
                                            {{ agentOption.uniqueName }}
                                        </span>
                                    </ng-template>
                                    <ng-template pTemplate="selectedItem">
                                        <span>
                                            {{
                                                addOtcForm.controls.agent.value
                                                    ?.uniqueName
                                            }}:
                                            {{
                                                addOtcForm.controls.agent.value
                                                    ?.contactPersonFirstName
                                            }}
                                            {{
                                                addOtcForm.controls.agent.value
                                                    ?.contactPersonLastName
                                            }}</span
                                        >
                                    </ng-template>
                                </p-dropdown>
                            </div>
                        </div>
                        <div class="field-row-container">
                            <div class="field-container checkbox-container">
                                <p-checkbox
                                    formControlName="isComplimentary"
                                    inputId="isComplimentary"
                                    [binary]="true"
                                ></p-checkbox>
                                <label htmlFor="isComplimentary"
                                    >Is Complimentary?</label
                                >
                            </div>
                        </div>
                        <!-- <h3>Traveler Information</h3> -->
                        <div class="field-row-container">
                            <!-- first name -->
                            <div class="field-container">
                                <label htmlFor="firstName">First Name</label>
                                <input
                                    pInputText
                                    name="firstName"
                                    label="firstName"
                                    formControlName="firstName"
                                />
                            </div>

                            <!-- last name -->
                            <div class="field-container">
                                <label htmlFor="lastName">Last Name</label>
                                <input
                                    pInputText
                                    name="lastName"
                                    label="lastName"
                                    formControlName="lastName"
                                />
                            </div>
                        </div>

                        <div class="field-row-container">
                            <!-- phone number -->
                            <div class="field-container">
                                <label htmlFor="phoneNumber"
                                    >Phone Number</label
                                >
                                <app-phone-number
                                    formControlName="phoneNumber"
                                ></app-phone-number>
                            </div>

                            <!-- email -->
                            <div class="field-container">
                                <label htmlFor="email">Email</label>
                                <input
                                    pInputText
                                    name="email"
                                    label="email"
                                    formControlName="email"
                                />
                            </div>
                        </div>

                        <!-- <h3>Participants</h3> -->
                        <div class="participant-fields-container">
                            <div class="row-container">
                                <!-- adults -->
                                <div class="field-container">
                                    <label htmlFor="adults">Adults</label>
                                    <input
                                        pInputText
                                        name="adults"
                                        label="adults"
                                        type="number"
                                        formControlName="adults"
                                    />
                                </div>

                                <!-- children -->
                                <div class="field-container">
                                    <label htmlFor="children">Children</label>
                                    <input
                                        pInputText
                                        name="children"
                                        label="children"
                                        type="number"
                                        formControlName="children"
                                    />
                                </div>

                                <!-- infants -->
                                <div class="field-container">
                                    <label htmlFor="infants">Infants</label>
                                    <input
                                        pInputText
                                        name="infants"
                                        label="infants"
                                        type="number"
                                        formControlName="infants"
                                    />
                                </div>

                                <div class="field-container">
                                    <label htmlFor="total-particpants"
                                        >Total</label
                                    >
                                    <input
                                        pInputText
                                        name="total-particpants"
                                        label="Total Participants"
                                        type="number"
                                        [disabled]="true"
                                        [value]="
                                            (addOtcForm.controls.adults.value ||
                                                0) +
                                            (addOtcForm.controls.children
                                                .value || 0) +
                                            (addOtcForm.controls.infants
                                                .value || 0)
                                        "
                                    />
                                </div>
                            </div>
                            <ng-container
                                *ngIf="displayOverbookWarning$ | async"
                            >
                                <div
                                    class="participant-notice-container warning"
                                >
                                    <i class="pi pi-exclamation-circle"></i>
                                    <span class="body-m"
                                        >You have exceeded the maximum number of
                                        seats available on this departure</span
                                    >
                                </div>
                            </ng-container>
                            <ng-container
                                *ngIf="
                                    (addOtcForm.controls.adults.dirty ||
                                        addOtcForm.controls.children.dirty) &&
                                    addOtcForm.controls.adults
                                        .errors as participantErrors
                                "
                            >
                                <ng-container
                                    *ngIf="
                                        participantErrors[
                                            'totalPassengersIsZero'
                                        ]
                                    "
                                >
                                    <div
                                        class="participant-notice-container error"
                                    >
                                        <i class="pi pi-exclamation-circle"></i>
                                        <span class="body-m">
                                            Atleast 1 adult/children is
                                            required</span
                                        >
                                    </div>
                                </ng-container>
                                <ng-container
                                    *ngIf="participantErrors['overbooked']"
                                >
                                    <div
                                        class="participant-notice-container error"
                                    >
                                        <i class="pi pi-exclamation-circle"></i>
                                        <span class="body-m"
                                            >You have exceeded the maximum
                                            number of seats available on this
                                            departure</span
                                        >
                                    </div>
                                </ng-container>
                            </ng-container>
                        </div>

                        <!-- <h3>Additional Information</h3> -->

                        <div class="field-row-container">
                            <!-- cruise ship -->
                            <!-- <div class="field-container">
                                <label htmlFor="cruiseLine">Cruise Line</label>
                                <p-dropdown
                                    autocomplete="off"
                                    optionLabel="shipCompanyName"
                                    optionValue="shipCompanyId"
                                    [autoDisplayFirst]="false"
                                    placeholder="Select Cruise Line"
                                    [options]="formDropdowns.cruiseLines || []"
                                    [showClear]="true"
                                    formControlName="cruiseLine"
                                    [autoDisplayFirst]="false"
                                    appendTo="body"
                                >
                                </p-dropdown>
                            </div> -->

                            <div class="field-container">
                                <label htmlFor="ship">Cruise Ship</label>
                                <p-dropdown
                                    id="ship"
                                    name="ship"
                                    formControlName="ship"
                                    autocomplete="off"
                                    optionLabel="shipName"
                                    optionValue="shipId"
                                    placeholder="Select Cruise Ship"
                                    [autoDisplayFirst]="false"
                                    [options]="formDropdowns.shipsInPort || []"
                                    [showClear]="true"
                                    formControlName="shipId"
                                    appendTo="body"
                                >
                                </p-dropdown>
                            </div>
                        </div>
                        <div class="field-row-container">
                            <!-- pickup location -->
                            <div class="field-container">
                                <label htmlFor="pickupLocation"
                                    >Pickup Location</label
                                >
                                <p-dropdown
                                    [options]="
                                        formDropdowns.pickupLocations &&
                                        formDropdowns.pickupLocations.length > 0
                                            ? formDropdowns.pickupLocations
                                            : []
                                    "
                                    placeholder="Select Pickup Location"
                                    optionLabel="pickupLocationName"
                                    optionValue="pickupLocationID"
                                    formControlName="pickupLocationId"
                                    [autoDisplayFirst]="false"
                                    [showClear]="true"
                                    appendTo="body"
                                >
                                </p-dropdown>
                            </div>
                        </div>

                        <!-- notes -->
                        <div class="field-container">
                            <label htmlFor="notes">Notes</label>
                            <textarea
                                pInputTextarea
                                name="notes"
                                label="notes"
                                formControlName="notes"
                            ></textarea>
                        </div>
                        <div class="action-container">
                            <ng-container *ngIf="data.status === 'error'">
                                <span class="text-error"
                                    >Failed to add booking</span
                                >
                            </ng-container>
                            <button
                                pButton
                                class="btn btn-primary"
                                type="submit"
                                [loading]="data.status === 'loading'"
                            >
                                Save
                            </button>
                        </div>
                    </form>
                </ng-container>
            </ng-container>
        </div>
    </p-dialog>
</ng-container>
