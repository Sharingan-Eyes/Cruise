<div class="outer-container">
    <div class="header">
        <h2>Statements</h2>
        <div class="button-container">
            <button
                pButton
                class="btn btn-primary"
                (click)="reconcileInvoices()"
                [appPermission]="{features: [{
                    feature: features.bookingManagementAgentEdit.name,
                    page: features.bookingManagementAgentEdit.pages
                        .statements.name,
                    pageFeature: [
                        features.bookingManagementAgentEdit.pages.statements
                        .features.reconcileInvoices.name
                    ],
                    pageFeatureCheck: 'and',
                }], mode: 'disabled',}"
            >
                Reconcile Invoices
            </button>
        </div>
    </div>
    <div class="main-content-container">
        <ng-container
            *ngIf="{
                statements: statements$ | async,
                status: status$ | async
            } as config"
        >
            <ng-container [ngSwitch]="config.status">
                <ng-container *ngSwitchCase="'loading'">
                    <app-loader-embed [isDisplayed]="true"></app-loader-embed>
                </ng-container>
                <ng-container *ngSwitchCase="'error'">
                    <div class="error-state">
                        <span>Error loading agents</span>
                        <button pButton>Retry</button>
                    </div>
                </ng-container>
                <ng-container *ngSwitchCase="'success'">
                    <ng-container
                        *ngIf="
                            config.statements && config.statements.length > 0;
                            noUsers
                        "
                    >
                        <div class="table-container">
                            <p-table
                                #dt1
                                [value]="config.statements"
                                styleClass="statement-list-table"
                                [scrollable]="true"
                                dataKey="month"
                                [tableStyle]="{ width: '100%' }"
                                [rows]="20"
                                [rowsPerPageOptions]="[50, 100, 200]"
                                [paginator]="true"
                                [showCurrentPageReport]="true"
                                currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                            >
                                <ng-template pTemplate="caption">
                                    <div class="content-header-container">
                                        <div class="left-container">
                                            <div
                                                class="year-calendar-container"
                                            >
                                                <p-floatLabel>
                                                    <p-calendar
                                                        [(ngModel)]="year"
                                                        dateFormat="yy"
                                                        view="year"
                                                        (ngModelChange)="
                                                            yearChange()
                                                        "
                                                    />
                                                    <label for="year"
                                                        >Select Year</label
                                                    >
                                                </p-floatLabel>
                                            </div>
                                        </div>
                                    </div>
                                </ng-template>

                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Month</th>
                                        <th>Amount</th>
                                        <th>Open Balance</th>
                                        <th>Status</th>
                                        <th
                                            alignFrozen="right"
                                            pFrozenColumn
                                            [appPermission]="{features: [{
                                                feature: features.bookingManagementAgentEdit.name,
                                                page: features.bookingManagementAgentEdit.pages
                                                    .statements.name,
                                                pageFeature: [
                                                    features.bookingManagementAgentEdit.pages
                                                        .statements.features
                                                        .viewStatement.name
                                                ],
                                                pageFeatureCheck: 'and',
                                            }], mode: 'none',}"
                                        >
                                            Actions
                                        </th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-item>
                                    <tr>
                                        <td>{{ item.month || '-' }}</td>
                                        <td>
                                            {{
                                                item.totalSalesAmount
                                                    | currency : 'USD' || '-'
                                            }}
                                        </td>
                                        <td>
                                            {{
                                                item.totalOpenBalance
                                                    | currency : 'USD' || '-'
                                            }}
                                        </td>
                                        <td
                                            [ngClass]="{
                                                'highlight-red':
                                                    getOverdueString(
                                                        item.endDate
                                                    ) != 'Not overdue'
                                            }"
                                        >
                                            {{
                                                item.totalOpenBalance > 0
                                                    ? getDateValueOf(
                                                          item.endDate
                                                      ) < currentDateValueOf()
                                                        ? getOverdueString(
                                                              item.endDate
                                                          )
                                                        : item.totalSalesAmount >
                                                          0
                                                        ? 'Current'
                                                        : '--'
                                                    : getDateValueOf(
                                                          item.endDate
                                                      ) < currentDateValueOf()
                                                    ? item.totalSalesAmount > 0
                                                        ? 'Paid'
                                                        : '--'
                                                    : 'Future'
                                            }}
                                        </td>
                                        <td
                                            alignFrozen="right"
                                            pFrozenColumn
                                            [appPermission]="{features: [{
                                                feature: features.bookingManagementAgentEdit.name,
                                                page: features.bookingManagementAgentEdit.pages
                                                    .statements.name,
                                                pageFeature: [
                                                    features.bookingManagementAgentEdit.pages
                                                        .statements.features
                                                        .viewStatement.name
                                                ],
                                                pageFeatureCheck: 'and',
                                            }], mode: 'none',}"
                                        >
                                            <div class="actions-container">
                                                <button
                                                    pButton
                                                    class="p-button-text edit"
                                                    icon="pi pi-eye"
                                                    (click)="
                                                        openViewStatementPage(
                                                            item.startDate,
                                                            item.endDate,
                                                            item.agentId,
                                                            item.month,
                                                            year.getFullYear()
                                                        )
                                                    "
                                                    [appPermission]="{features: [{
                                                        feature: features.bookingManagementAgentEdit.name,
                                                        page: features.bookingManagementAgentEdit.pages
                                                            .statements.name,
                                                        pageFeature: [
                                                            features.bookingManagementAgentEdit.pages
                                                                .statements.features
                                                                .viewStatement.name
                                                        ],
                                                        pageFeatureCheck: 'and',
                                                    }], mode: 'none',}"
                                                ></button>
                                            </div>
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </ng-container>
                    <ng-template #noUsers>
                        <div class="empty-state">
                            <span>You don't have any statements.</span>
                        </div>
                    </ng-template>
                </ng-container>
            </ng-container>
        </ng-container>
    </div>
</div>
